<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.111.3"><meta name=generator content="Relearn 5.12.6+tip"><meta name=description content="Thinging for all things."><meta name=author content="programmingcat"><title>Wallet - Thinging X</title><link href=http://thinkingx.xyz/blockchain/wallet/index.html rel=canonical type=text/html title="Wallet - Thinging X"><link href=/blockchain/wallet/index.xml rel=alternate type=application/rss+xml title="Wallet - Thinging X"><link href=/images/favicon.svg?1703641023 rel=icon type=image/svg+xml><link href=/css/fontawesome-all.min.css?1703641023 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css?1703641023 rel=stylesheet></noscript><link href=/css/nucleus.css?1703641023 rel=stylesheet><link href=/css/auto-complete.css?1703641023 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/auto-complete.css?1703641023 rel=stylesheet></noscript><link href=/css/perfect-scrollbar.min.css?1703641023 rel=stylesheet><link href=/css/fonts.css?1703641023 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css?1703641023 rel=stylesheet></noscript><link href=/css/theme.css?1703641023 rel=stylesheet><link href=/css/theme-learn.css?1703641023 rel=stylesheet id=variant-style><link href=/css/variant.css?1703641023 rel=stylesheet><link href=/css/print.css?1703641023 rel=stylesheet media=print><link href=/css/format-print.css?1703641023 rel=stylesheet><link href=/css/ie.css?1703641023 rel=stylesheet><script src=/js/url.js?1703641023></script>
<script src=/js/variant.js?1703641023></script>
<script>window.index_js_url="/index.search.js";var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="http://thinkingx.xyz/",window.variants&&variants.init(["learn","relearn-light","relearn-dark","relearn-bright","neon","blue","green","red"])</script></head><body class="mobile-support print" data-url=/blockchain/wallet/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Overview</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/blockchain/index.html><span itemprop=name>Blockchain</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Wallet</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=wallet>Wallet</h1><p>作为用户，Wallet 是区块链的入口；现阶段主流的 Wallet 类型有：HD Wallet，MultiSig wallet，Custodial wallet，Hardware wallet，Paper wallet，MPC Wallet 等。作为开发者，HD Wallet、MultiSig Wallet、MPC Wallet 是需要重点掌握的。</p><h2 id=hd-wallet>HD wallet</h2><p>钱包是用来存钱的，在区块链中，我们的数字资产都会对应到一个账户地址上， 只有拥有账户的钥匙（私钥）才可以对资产进行消费（用私钥对消费交易签名）。</p><p>他们之间的关系如下：</p><p><a href=#image-102221fef5d9be69e4e8a10cbc23145c class=lightbox-link><img src="/images/blockchain/priv-pub-address-rel.png?classes=shadow" alt=wallet class=shadow style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-102221fef5d9be69e4e8a10cbc23145c><img src="/images/blockchain/priv-pub-address-rel.png?classes=shadow" alt=wallet class=lightbox-image loading=lazy></a></p><p>私钥通过椭圆曲线生成公钥， 公钥通过哈希函数生成地址，这两个过程都是单向的; 所以，数字钱包实际是一个管理私钥（生成、存储、签名）的工具，注意钱包并不保存资产，资产是在链上的。</p><blockquote><p>生成私钥的本质是在 1 到 2^256 之间选一个数字：生成密钥的第一步也是最重要的一步，是要找到足够安全的熵源，即随机性来源，只要选取的结果是不可预测或不可重复的</p></blockquote><p>HD, Hierarchical Deterministic, 叫做分层确定性钱包，是一种可以从单个种子（seed）衍生出一系列私钥的钱包结构，这些私钥都可以被根种子所控制，这样就可以用一个种子来管理多个账户。</p><p>在 Mastering Bitcoin 中，有一章是来介绍 Wallet 的，有必要看一下：<a href=https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch05.asciidoc target=_blank>Mastering Bitcoin - Wallet</a>, <a href="https://drive.google.com/file/d/16mdtupaXPfJOyFS8YBzJ4O25HfD00Pg9/view?usp=sharing" target=_blank>中文版看这里</a></p><p>HD 钱包允许我们使用一个密钥管理很多个衍生私钥，进而控制多个地址，bip32 规范中使用一种树形结构来进行管理。</p><p><a href=#image-471945cb3dfdfc569f0550a826a532eb class=lightbox-link><img src="/images/blockchain/hd_01.png?classes=shadow&amp;height=400px" alt="HD Bip32" class=shadow style=height:400px;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-471945cb3dfdfc569f0550a826a532eb><img src="/images/blockchain/hd_01.png?classes=shadow&amp;height=400px" alt="HD Bip32" class=lightbox-image loading=lazy></a></p><p>关于 HD wallet 有一系列规范：</p><ul><li><a href=https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki target=_blank>bip32</a></li><li><a href=https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki target=_blank>bip44</a></li><li><a href=https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki target=_blank>bip39</a></li><li><a href=https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki target=_blank>bip43</a></li></ul><h3 id=bip39>bip39</h3><p>bip39 规范主要关于生成确定性密钥的助记码，使用一组预定义的单词来表示一串随机数，这样就可以方便的记忆和传输。主要包含两部分：生成助记码和从主机码转成二进制私钥种子。</p><p>我们来看看 bip39 的技术细节</p><p><strong>如何生成助机词</strong></p><ol><li>Create a random sequence (entropy) of 128 to 256 bits.</li><li>Create a checksum of the random sequence by taking the first (entropy-length/32) bits of its SHA256 hash.</li><li>Add the checksum to the end of the random sequence.</li><li>Split the result into 11-bit length segments.</li><li>Map each 11-bit value to a word from the predefined dictionary of 2048 words.</li><li>The mnemonic code is the sequence of words.</li></ol><p><a href=#image-3937d2157f7e0eb6999a72e15a5e6294 class=lightbox-link><img src="/images/blockchain/bip39-1.png?classes=shadow&amp;height=400px" alt class=shadow style=height:400px;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-3937d2157f7e0eb6999a72e15a5e6294><img src="/images/blockchain/bip39-1.png?classes=shadow&amp;height=400px" alt class=lightbox-image loading=lazy></a></p><p>随机熵和单词长度的关系：</p><table><thead><tr><th>Entropy (bits)</th><th>Checksum (bits)</th><th>Entropy + checksum (bits)</th><th>Mnemonic length (words)</th></tr></thead><tbody><tr><td>128</td><td>4</td><td>132</td><td>12</td></tr><tr><td>160</td><td>5</td><td>165</td><td>15</td></tr><tr><td>192</td><td>6</td><td>198</td><td>18</td></tr><tr><td>224</td><td>7</td><td>231</td><td>21</td></tr><tr><td>256</td><td>8</td><td>264</td><td>24</td></tr></tbody></table><p><strong>用助记词生成种子</strong></p><ol><li>The first parameter to the PBKDF2 key-stretching function is the mnemonic produced from step 6.</li><li>The second parameter to the PBKDF2 key-stretching function is a salt. The salt is composed of the string constant &ldquo;mnemonic&rdquo; concatenated with an optional user-supplied passphrase string.</li><li>PBKDF2 stretches the mnemonic and salt parameters using 2048 rounds of hashing with the HMAC-SHA512 algorithm, producing a 512-bit value as its final output. That 512-bit value is the seed.</li></ol><p><a href=#image-1fb8726eabcca26c762d49d4706fd193 class=lightbox-link><img src="/images/blockchain/bip39-2.png?classes=shadow&amp;height=400px" alt class=shadow style=height:400px;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1fb8726eabcca26c762d49d4706fd193><img src="/images/blockchain/bip39-2.png?classes=shadow&amp;height=400px" alt class=lightbox-image loading=lazy></a></p><p>参考实现：</p><ul><li><a href=https://github.com/tyler-smith/go-bip39 target=_blank>go 版本的 bip39 实现</a></li></ul><p>源码解析</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewEntropy</span>(<span style=color:#a6e22e>bitSize</span> <span style=color:#66d9ef>int</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 验证位数在 128 到 256 之间，并且是 32 的倍数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>validateEntropyBitSize</span>(<span style=color:#a6e22e>bitSize</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>entropy</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>bitSize</span><span style=color:#f92672>/</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 这里使用的是 crypto/rand 包，而不是 math/rand 包，因为 math/rand 包是伪随机数生成器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这里显然需要一个真随机数生成器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>entropy</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>entropy</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 用法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>entropy</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bip39</span>.<span style=color:#a6e22e>NewEntropy</span>(<span style=color:#ae81ff>256</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>mnemonic</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bip39</span>.<span style=color:#a6e22e>NewMnemonic</span>(<span style=color:#a6e22e>entropy</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>seed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bip39</span>.<span style=color:#a6e22e>NewSeed</span>(<span style=color:#a6e22e>mnemonic</span>, <span style=color:#e6db74>&#34;hello&#34;</span>)
</span></span></code></pre></div><p>总结一下：bip39 的主要作用就是把随机生成的 seed 转成助记词，方便记忆、传输等，不管是导入、导出还是备份都非常方便，并且从助记词也可以还原出 seed。</p><h3 id=bip32--bip44>bip32 & bip44</h3><p><strong>从种子生成钱包</strong></p><p>上面了解了 bip39，通过 bip39 我们可以获取一个助记词序列，它本质上是一个随机数，这个随机数被用来当作 seed 来生成私钥。bip32 规范主要是定义了从 seed 生成私钥的过程，它定义了一种树形结构来管理私钥，这种树形结构的每个节点都有一个索引，这个索引可以用来生成子节点，这样就可以方便的管理多个私钥。</p><p><a href=#image-1914aebf6f83ceb88efc7cb0840a79d6 class=lightbox-link><img src="/images/blockchain/bip44-1.webp?classes=shadow" alt class=shadow style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1914aebf6f83ceb88efc7cb0840a79d6><img src="/images/blockchain/bip44-1.webp?classes=shadow" alt class=lightbox-image loading=lazy></a></p><p>关于 extended key 也可以看这里：<a href=https://learnmeabitcoin.com/technical/extended-keys target=_blank>extended keys</a></p><p>参考实现</p><ul><li><a href=https://github.com/btcsuite/btcd/tree/master/btcutil/hdkeychain target=_blank>go 版本的 hdkeychain</a> - 里面包含对 extended key 的实现，也就是实现了 bip32 规范</li></ul><h3 id=keys-和-addresses>Keys 和 Addresses</h3><p>在上面介绍的几个 bip 规范中，其实少了一些细节，比如私钥如何生成公钥？公钥如何生成地址？不同的链使用的算法都一样吗？&mldr;</p><p>关于这些问题可以参考这篇文章：<a href=https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch04.asciidoc target=_blank>Mastering Bitcoin - Keys and Addresses</a></p><table><thead><tr><th>Chain</th><th>Private Key -> Public Key</th><th>Compressed Public Key ?</th><th>Public Key -> Address</th><th>Address Format</th></tr></thead><tbody><tr><td>BTC</td><td>ECDSA (ecc Secp256k1)</td><td>Yes</td><td>SHA256 + RIPEMD160</td><td>Base58</td></tr><tr><td>ETH</td><td>ECDSA (ecc Secp256k1)</td><td>Yes</td><td>Keccak256</td><td>Hex</td></tr><tr><td>BNB</td><td>ECDSA (ecc Secp256k1)</td><td>Yes</td><td>Keccak256</td><td>Bech32</td></tr></tbody></table><p>对于地址生成算法，不同的链不太一样</p><ul><li>Bitcoin 采用 SHA256 + RIPEMD160, 然后再进行 Base58 编码</li><li>Ethereum 采用 Keccak256, 然后再进行 Hex 编码<ul><li>对公钥做 Keccak-256 哈希运算，然后取最后的 40 位 16 进制字符</li></ul></li></ul><h2 id=实现一个支持多链的-hd-本地钱包>实现一个支持多链的 HD 本地钱包</h2><p>一些想法</p><ul><li>这个本地钱包，我们暂时叫他 hdkms，后面都这么叫</li><li>hdkms 支持管理多个钱包，可以通过指定 name 来区分不同的 hd wallet<ul><li>wallet1 -> mnemonic -> seed -> master private key -> local keystore file1</li><li>wallet2 -> mnemonic -> seed -> master private key -> local keystore file2</li></ul></li><li>hdkms 支持导入助记词、私钥</li><li>hdkms 支持导出助记词、私钥</li><li>hdkms 支持生成地址，并且可以指定 index</li><li>hdkms 可以查看 address 的余额</li><li>hdkms 支持多链<ul><li>比如 Bitcoin, Ethereum, Binance Smart Chain etc.</li></ul></li><li>hdkms 可以离线签署交易，生成签名后的交易数据<ul><li>支持 native token 的 transfer</li><li>支持 erc20</li><li>支持 NFT</li><li>支持任意类型的合约</li></ul></li><li>hdkms 可以在线广播交易<ul><li>broadcast tx</li><li>查询 tx 状态</li></ul></li><li>hdkms 一些高级功能<ul><li>支持 event 监听</li><li>支持动态手续费，比如 gas fee，network fee 等</li><li>&mldr;</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 考虑怎么使用</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  1. 提供命令行工具，比如 hd-kms </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建钱包</span>
</span></span><span style=display:flex><span>hdkms wallet generate --wallet-name test1 --passphase <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hdkms wallet import --wallet-name test1 --mnemonic <span style=color:#e6db74>&#34;&#34;</span> --passphase <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ hdkms wallet export --wallet-name test1
</span></span><span style=display:flex><span>$ <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;mnemonic&#34;</span>: <span style=color:#e6db74>&#34;xxx&#34;</span>, <span style=color:#e6db74>&#34;passphase&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>TODOs</p><ul><li><input checked disabled type=checkbox> 搭建起项目的基本框架<ul><li><input checked disabled type=checkbox> 搞定 cli 及其扩展子命令</li><li><input checked disabled type=checkbox> 支持多个子命令的调用，比如 hdkms wallet generate, hdkms wallet list &mldr;</li></ul></li><li><input disabled type=checkbox> 支持 Ethereum<ul><li><input disabled type=checkbox> generate wallet</li><li><input disabled type=checkbox> mnemonic</li><li><input disabled type=checkbox> store mnemonic or private key to local keystore file</li><li><input disabled type=checkbox> get address by index</li><li><input disabled type=checkbox> query balance by address</li></ul></li></ul><footer class=footline></footer></article></div></main></div><script src=/js/clipboard.min.js?1703641023 defer></script>
<script src=/js/perfect-scrollbar.min.js?1703641023 defer></script>
<script src=/js/d3/d3-color.min.js?1703641023 defer></script>
<script src=/js/d3/d3-dispatch.min.js?1703641023 defer></script>
<script src=/js/d3/d3-drag.min.js?1703641023 defer></script>
<script src=/js/d3/d3-ease.min.js?1703641023 defer></script>
<script src=/js/d3/d3-interpolate.min.js?1703641023 defer></script>
<script src=/js/d3/d3-selection.min.js?1703641023 defer></script>
<script src=/js/d3/d3-timer.min.js?1703641023 defer></script>
<script src=/js/d3/d3-transition.min.js?1703641023 defer></script>
<script src=/js/d3/d3-zoom.min.js?1703641023 defer></script>
<script src=/js/mermaid.min.js?1703641023 defer></script>
<script>window.themeUseMermaid=JSON.parse("{}")</script><script src=/js/theme.js?1703641023 defer></script></body></html>